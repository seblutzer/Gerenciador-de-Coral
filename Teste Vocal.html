
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Extens√£o Vocal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 40px 30px;
        }

        .section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }

        .status-box {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
        }

        canvas {
            width: 100%;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            margin-bottom: 20px;
            background: #f8f9fa;
        }

        #pitchCanvas {
            height: 350px;
        }

        .chart-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #555;
        }

        .chart-info-row {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 15px;
        }

        .chart-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-info-item strong {
            color: #333;
            min-width: 80px;
        }

        .chart-info-value {
            font-weight: 600;
            color: #667eea;
            font-size: 16px;
            font-family: monospace;
        }

        .progress-container {
            margin: 20px 0;
        }

        .progress-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #84fab0 0%, #8fd3f4 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 30px 0;
        }

        button {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(245, 87, 108, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .result-section {
            display: none;
        }

        .result-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
        }

        .result-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .result-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .result-item {
            background: rgba(255, 255, 255, 0.2);
            padding: 20px;
            border-radius: 10px;
        }

        .result-item-label {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .result-item-value {
            font-size: 28px;
            font-weight: 700;
        }

        .classification-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .classification-group {
            margin-bottom: 20px;
        }

        .classification-group:last-child {
            margin-bottom: 0;
        }

        .classification-group h4 {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }

        .voice-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .voice-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            color: white;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .badge-soprano {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .badge-mezzo {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: #333;
        }

        .badge-contralto {
            background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
        }

        .badge-tenor {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: #333;
        }

        .badge-baritono {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .badge-baixo {
            background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%);
            color: #333;
        }

        .closest-voice-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 15px;
            border-left: 4px solid #f5576c;
        }

        .closest-voice-name {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .closest-voice-deficit {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .deficit-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .deficit-item-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .deficit-item-value {
            font-size: 16px;
            font-weight: 700;
            color: #f5576c;
        }

        .closest-voice-side {
            font-size: 13px;
            color: #666;
            text-align: center;
            padding: 8px;
            background: #f0f0f0;
            border-radius: 6px;
        }

        .closest-voice-side strong {
            color: #333;
        }

        .notes-detected {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
            justify-content: center;
        }

        .note-badge {
            background: linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .no-result-message {
            text-align: center;
            color: #666;
            font-size: 14px;
            padding: 10px;
        }

        @media (max-width: 600px) {
            .header h1 {
                font-size: 22px;
            }

            button {
                min-width: 120px;
                padding: 10px 20px;
                font-size: 14px;
            }

            #pitchCanvas {
                height: 250px;
            }

            .result-content {
                grid-template-columns: 1fr;
            }

            .closest-voice-deficit {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé§ Teste de Extens√£o Vocal</h1>
            <p>Descubra o alcance da sua voz e seu tipo vocal</p>
        </div>

        <div class="content">
            <div class="section">
                <div class="status-box" id="testStatus">
                    Clique abaixo para come√ßar
                </div>

                <canvas id="pitchCanvas"></canvas>

                <div class="chart-info" id="chartInfo">
                    <div class="chart-info-row">
                        <div class="chart-info-item">
                            <strong>Nota:</strong>
                            <span class="chart-info-value" id="chartNote">--</span>
                        </div>
                        <div class="chart-info-item">
                            <strong>Frequ√™ncia:</strong>
                            <span class="chart-info-value" id="chartFreq">-- Hz</span>
                        </div>
                        <div class="chart-info-item">
                            <strong>Tempo:</strong>
                            <span class="chart-info-value" id="chartTime">0.0s</span>
                        </div>
                    </div>
                </div>

                <div class="progress-container" id="progressContainer">
                    <div class="progress-label">
                        <span id="progressLabel">Progresso</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                </div>

                <div class="notes-detected" id="notesDetected"></div>

                <div class="button-group">
                    <button class="btn-primary" id="startTestBtn" onclick="startVocalTest()">
                        üé§ Iniciar Teste
                    </button>
                    <button class="btn-danger" id="stopTestBtn" onclick="stopVocalTest()" style="display: none;">
                        ‚èπÔ∏è Parar Teste
                    </button>
                </div>

                <div class="result-section" id="resultSection">
                    <div class="result-card">
                        <div class="result-title">‚ú® Resultado Final</div>
                        <div class="result-content">
                            <div class="result-item">
                                <div class="result-item-label">Nota Mais Aguda</div>
                                <div class="result-item-value" id="resultHighest">--</div>
                            </div>
                            <div class="result-item">
                                <div class="result-item-label">Nota Mais Grave</div>
                                <div class="result-item-value" id="resultLowest">--</div>
                            </div>
                            <div class="result-item">
                                <div class="result-item-label">Alcance Total</div>
                                <div class="result-item-value" id="resultRange">--</div>
                            </div>
                        </div>

                        <div class="classification-section" id="analysisResults">
                            <!-- Ser√° preenchido dinamicamente -->
                        </div>

                        <div class="button-group">
                            <button class="btn-primary" onclick="resetVocalTest()">
                                üîÑ Fazer Teste Novamente
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===================== CONSTANTES =====================
        const NOTES_FREQUENCY = {
            'C1': 32.70, 'C#1': 34.65, 'D1': 36.71, 'D#1': 38.89, 'E1': 41.20, 'F1': 43.65,
            'F#1': 46.25, 'G1': 49.00, 'G#1': 51.96, 'A1': 55.00, 'A#1': 58.27, 'B1': 61.74,
            'C2': 65.41, 'C#2': 69.30, 'D2': 73.42, 'D#2': 77.78, 'E2': 82.41, 'F2': 87.31,
            'F#2': 92.50, 'G2': 98.00, 'G#2': 103.83, 'A2': 110.00, 'A#2': 116.54, 'B2': 123.47,
            'C3': 130.81, 'C#3': 138.59, 'D3': 146.83, 'D#3': 155.56, 'E3': 164.81, 'F3': 174.61,
            'F#3': 185.00, 'G3': 196.00, 'G#3': 207.65, 'A3': 220.00, 'A#3': 233.08, 'B3': 246.94,
            'C4': 261.63, 'C#4': 277.18, 'D4': 293.66, 'D#4': 311.13, 'E4': 329.63, 'F4': 349.23,
            'F#4': 369.99, 'G4': 392.00, 'G#4': 415.30, 'A4': 440.00, 'A#4': 466.16, 'B4': 493.88,
            'C5': 523.25, 'C#5': 554.37, 'D5': 587.33, 'D#5': 622.25, 'E5': 659.25, 'F5': 698.46,
            'F#5': 739.99, 'G5': 783.99, 'G#5': 830.61, 'A5': 880.00, 'A#5': 932.33, 'B5': 987.77,
            'C6': 1046.50, 'C#6': 1108.73, 'D6': 1174.66, 'D#6': 1244.51, 'E6': 1318.51, 'F6': 1396.91,
            'F#6': 1479.98, 'G6': 1567.98, 'G#6': 1661.22, 'A6': 1760.00, 'A#6': 1864.66, 'B6': 1975.53,
            'C7': 2093.00
        };

        const REQUIRED_TIME_PER_PHASE = 1; // segundos

        const NOTE_NAMES = Object.keys(NOTES_FREQUENCY).sort((a, b) => NOTES_FREQUENCY[a] - NOTES_FREQUENCY[b]);

        const VOICE_BASE_RANGES = {
            "Soprano": { min: 261.63, max: 880.00, minNote: "C4", maxNote: "A5" },
            "Mezzo-soprano": { min: 220.00, max: 698.46, minNote: "A3", maxNote: "F5" },
            "Contralto": { min: 174.61, max: 587.33, minNote: "F3", maxNote: "D5" },
            "Tenor": { min: 130.81, max: 392.00, minNote: "C3", maxNote: "G4" },
            "Bar√≠tono": { min: 98.00, max: 329.63, minNote: "G2", maxNote: "E4" },
            "Baixo": { min: 82.41, max: 261.63, minNote: "E2", maxNote: "C4" }
        };

        const VOICE_COLORS = {
            "Soprano": "badge-soprano",
            "Mezzo-soprano": "badge-mezzo",
            "Contralto": "badge-contralto",
            "Tenor": "badge-tenor",
            "Bar√≠tono": "badge-baritono",
            "Baixo": "badge-baixo"
        };

        // ===================== ESTADO =====================
        let state = {
            audioContext: null,
            analyser: null,
            sourceNode: null,
            stream: null,
            isTestRunning: false,
            dataArray: null,
            waveformArray: null,
            lastRMS: 0,
            lastFreq: 0,
            highestNote: null,
            lowestNote: null,
            highestFreq: 0,
            lowestFreq: Infinity,
            detectedNotes: new Set(),
            pitchHistory: [],
            correctTime: 0,
            requiredTime: 3,
            phase: 'highest'
        };

        // ===================== INICIALIZA√á√ÉO √ÅUDIO =====================
        async function initAudio() {
            try {
                if (!state.audioContext) {
                    state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    state.analyser = state.audioContext.createAnalyser();
                    state.analyser.fftSize = 4096;
                    state.analyser.smoothingTimeConstant = 0.85;
                    state.dataArray = new Uint8Array(state.analyser.frequencyBinCount);
                    state.waveformArray = new Uint8Array(state.analyser.fftSize);
                }

                if (state.audioContext.state === 'suspended') {
                    state.audioContext.resume();
                }

                if (!state.stream) {
                    state.stream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false
                        }
                    });

                    if (!state.sourceNode) {
                        state.sourceNode = state.audioContext.createMediaStreamSource(state.stream);
                        state.sourceNode.connect(state.analyser);
                    }
                }

                return true;
            } catch (err) {
                alert('Erro ao acessar microfone: ' + err.message);
                return false;
            }
        }

        // ===================== DETECTOR DE PITCH =====================
        function detectPitchSpectral(frequencyData) {
            let maxValue = 0;
            let maxIndex = 0;

            for (let i = 5; i < frequencyData.length; i++) {
                if (frequencyData[i] > maxValue) {
                    maxValue = frequencyData[i];
                    maxIndex = i;
                }
            }

            if (maxValue < 30) return null;

            const nyquist = state.audioContext.sampleRate / 2;
            const freq = (maxIndex * nyquist) / frequencyData.length;

            if (freq < 50 || freq > 2000) return null;

            return freq;
        }

        function analyzeAudio() {
            state.analyser.getByteFrequencyData(state.dataArray);
            state.analyser.getByteTimeDomainData(state.waveformArray);

            let sum = 0;
            for (let i = 0; i < state.waveformArray.length; i++) {
                let normalized = (state.waveformArray[i] - 128) / 128;
                sum += normalized * normalized;
            }
            state.lastRMS = Math.sqrt(sum / state.waveformArray.length);

            let freq = detectPitchSpectral(state.dataArray);

            if (freq && state.lastRMS > 0.015) {
                state.lastFreq = freq;
                return freq;
            }

            return null;
        }

        function frequencyToNote(freq) {
            if (!freq || freq <= 0) return null;

            let minDiff = Infinity;
            let closestNote = null;

            for (const note of NOTE_NAMES) {
                const diff = Math.abs(freq - NOTES_FREQUENCY[note]);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestNote = note;
                }
            }

            const centsDiff = 1200 * Math.log2(freq / NOTES_FREQUENCY[closestNote]);
            if (Math.abs(centsDiff) <= 50) {
                return closestNote;
            }

            return null;
        }

        // ===================== AN√ÅLISE DE VOZES =====================
        function analyzeVoiceRanges(lowestFreq, highestFreq) {
            const vocesAlcancadas = [];
            let vozMaisProxima = null;

            // Guarda o menor d√©ficit em semitons encontrado entre as vozes n√£o perfeitas
            let menorDeficitSemitons = Infinity;

            for (const [voiceName, range] of Object.entries(VOICE_BASE_RANGES)) {
                // Frequ√™ncias correspondentes aos limites da voz (minNote e maxNote)
                const minNoteFreq = NOTES_FREQUENCY[range.minNote];
                const maxNoteFreq = NOTES_FREQUENCY[range.maxNote];

                // Voz alcan√ßada perfeitamente? (grave <= minNote e agudo >= maxNote)
                if (lowestFreq <= minNoteFreq && highestFreq >= maxNoteFreq) {
                    vocesAlcancadas.push(voiceName);
                    continue;
                }

                // Deficits para chegar aos endpoints (quando n√£o alcan√ßa perfeitamente)
                let deficitGraveSemitons = 0;
                let deficitAgudoSemitons = 0;
                // Verifica se precisa descer mais at√© o minNote
                if (lowestFreq > minNoteFreq) {
                    deficitGraveSemitons = Math.round(12 * Math.log2(lowestFreq / minNoteFreq));
                }

                // Verifica se precisa subir mais at√© o maxNote
                if (highestFreq < maxNoteFreq) {
                    deficitAgudoSemitons = Math.round(12 * Math.log2(maxNoteFreq / highestFreq));
                }

                // Se houver d√©ficit, escolhe a menor dist√¢ncia em semitons como "voz mais pr√≥xima"
                if (deficitGraveSemitons > 0 || deficitAgudoSemitons > 0) {
                    // Decide lado e d√©ficit total (pequeno ajuste para consist√™ncia com o restante)
                    let lado = deficitGraveSemitons <= deficitAgudoSemitons ? 'grave' : 'agudo';
                    let deficitSemitons = Math.min(deficitGraveSemitons, deficitAgudoSemitons);
                    // Se for a menor dist√¢ncia at√© agora, registra como voz mais pr√≥xima
                    if (deficitSemitons < menorDeficitSemitons) {
                        menorDeficitSemitons = deficitSemitons;
                        vozMaisProxima = {
                            nome: voiceName,
                            deficitGraveSemitons,
                            deficitAgudoSemitons,
                            deficitSemitons,
                            lado: lado
                        };
                    }
                }
            }

            return { vocesAlcancadas, vozMaisProxima };
        }
        // ===================== EXIBI√á√ÉO DE RESULTADOS =====================
        function displayVoiceAnalysis(vocesAlcancadas, vozMaisProxima) {
            const container = document.getElementById('analysisResults');
            let html = '';

            // Se√ß√£o de vozes alcan√ßadas
            html += '<div class="classification-group">';
            html += '<h4>üéØ Vozes Alcan√ßadas Perfeitamente:</h4>';
            if (vocesAlcancadas.length > 0) {
                html += '<div class="voice-badges">';
                vocesAlcancadas.forEach(voice => {
                    html += `<span class="voice-badge ${VOICE_COLORS[voice]}">‚úì ${voice}</span>`;
                });
                html += '</div>';
            } else {
                html += '<div class="no-result-message">Nenhuma voz alcan√ßada completamente</div>';
            }
            html += '</div>';

            // Se√ß√£o de voz mais pr√≥xima
            if (vozMaisProxima) {
                html += '<div class="classification-group">';
                html += '<h4>‚ö° Voz Mais Pr√≥xima:</h4>';
                html += '<div class="closest-voice-card">';
                html += `<div class="closest-voice-name">${vozMaisProxima.nome}</div>`;
                html += '<div class="closest-voice-deficit">';
                html += `<div class="deficit-item">
                    <div class="deficit-item-label">D√©ficit em Frequ√™ncia</div>
                    <div class="deficit-item-value">‚àí${vozMaisProxima.deficitHz} Hz</div>
                </div>`;
                html += `<div class="deficit-item">
                    <div class="deficit-item-label">D√©ficit em Semitons</div>
                    <div class="deficit-item-value">‚àí${Math.abs(vozMaisProxima.deficitSemitons)}</div>
                </div>`;
                html += '</div>';
                html += `<div class="closest-voice-side">Falta no lado <strong>${vozMaisProxima.lado}</strong></div>`;
                html += '</div>';
                html += '</div>';
            }

            container.innerHTML = html;
        }

        // ===================== TESTE VOCAL =====================
        async function startVocalTest() {
            if (!await initAudio()) return;

            state.isTestRunning = true;
            state.highestNote = null;
            state.lowestNote = null;
            state.highestFreq = 0;
            state.lowestFreq = Infinity;
            state.detectedNotes.clear();
            state.pitchHistory = [];
            state.phase = 'highest';
            state.correctTime = 0;

            document.getElementById('startTestBtn').style.display = 'none';
            document.getElementById('stopTestBtn').style.display = 'block';
            document.getElementById('pitchCanvas').style.display = 'block';
            document.getElementById('chartInfo').style.display = 'block';
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('testStatus').textContent = 'üé§ Cante a nota mais AGUDA!';

            state.testingTime = REQUIRED_TIME_PER_PHASE;

            runTestPhase();
        }

        function runTestPhase() {
            let phaseStartTime = Date.now();

            function update() {
                if (!state.isTestRunning) return;

                const freq = analyzeAudio();

                if (freq) {
                    // Atualiza frequ√™ncias
                    state.highestFreq = Math.max(state.highestFreq, freq);
                    state.lowestFreq = Math.min(state.lowestFreq, freq);

                    state.pitchHistory.push(freq);
                    if (state.pitchHistory.length > 200) state.pitchHistory.shift();

                    const note = frequencyToNote(freq);

                    if (note) {
                        state.detectedNotes.add(note);
                        state.correctTime += 0.016;
                        const progress = (state.correctTime / state.testingTime) * 100;
                        document.getElementById('progressFill').style.width = progress + '%';
                        document.getElementById('progressPercent').textContent = Math.round(progress) + '%';

                        if (state.phase === 'highest') {
                            state.highestNote = note;
                            document.getElementById('testStatus').textContent = `üéµ Nota aguda: ${note}`;
                            if (state.correctTime >= state.testingTime) {
                                state.phase = 'lowest';
                                state.correctTime = 0;
                                state.pitchHistory = [];
                                state.detectedNotes.clear();
                                document.getElementById('testStatus').textContent = '‚úì Agora cante a nota mais GRAVE!';
                                phaseStartTime = Date.now(); // reinicia o timer da nova fase
                            }
                        } else {
                            state.lowestNote = note;
                            document.getElementById('testStatus').textContent = `üéµ Nota grave: ${note}`;
                            if (state.correctTime >= state.testingTime) {
                                finishVocalTest();
                                return;
                            }
                        }
                    }
                } else {
                    state.correctTime = 0;
                }

                drawPitchChart();
                updateChartInfo();
                addDetectedNotes();

                requestAnimationFrame(update);
            }

            update();
        }

        function drawPitchChart() {
            const canvas = document.getElementById('pitchCanvas');
            if (!canvas.offsetParent) return;

            const ctx = canvas.getContext('2d');
            const width = canvas.offsetWidth;
            const height = canvas.offsetHeight;
            canvas.width = width;
            canvas.height = height;

            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);

            if (state.pitchHistory.length === 0) {
                ctx.fillStyle = '#999';
                ctx.font = '14px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('üé§ Come√ße a cantar...', width / 2, height / 2);
                return;
            }

            const pad = 60;
            const minFreq = 80;
            const maxFreq = 800;

            ctx.strokeStyle = '#f0f0f0';
            ctx.lineWidth = 1;
            for (let i = pad; i < height - pad; i += 30) {
                ctx.beginPath();
                ctx.moveTo(pad, i);
                ctx.lineTo(width - pad, i);
                ctx.stroke();
            }

            const freqToY = (f) => {
                return pad + (height - 2 * pad) * (1.0 - (Math.log2(f) - Math.log2(minFreq)) / (Math.log2(maxFreq) - Math.log2(minFreq)));
            };

            ctx.fillStyle = '#666';
            ctx.font = '11px sans-serif';
            ctx.textAlign = 'right';
            for (let f = minFreq; f <= maxFreq; f *= 2) {
                const note = frequencyToNote(f);
                if (note) {
                    const y = freqToY(f);
                    ctx.fillText(note, pad - 10, y + 4);
                }
            }

            ctx.strokeStyle = '#1f77b4';
            ctx.lineWidth = 2.5;
            ctx.beginPath();

            for (let i = 0; i < state.pitchHistory.length; i++) {
                const x = pad + (i / state.pitchHistory.length) * (width - 2 * pad);
                const y = freqToY(state.pitchHistory[i]);

                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();

            if (state.pitchHistory.length > 0) {
                const lastFreq = state.pitchHistory[state.pitchHistory.length - 1];
                const lastX = width - pad - 5;
                const lastY = freqToY(lastFreq);

                ctx.fillStyle = '#e74c3c';
                ctx.beginPath();
                ctx.arc(lastX, lastY, 5, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function updateChartInfo() {
            if (state.pitchHistory.length > 0) {
                const lastFreq = state.pitchHistory[state.pitchHistory.length - 1];
                const note = frequencyToNote(lastFreq);
                document.getElementById('chartNote').textContent = note || '?';
                document.getElementById('chartFreq').textContent = lastFreq.toFixed(1) + ' Hz';
                document.getElementById('chartTime').textContent = state.correctTime.toFixed(1) + 's / ' + state.testingTime + 's';
            }
        }

        function addDetectedNotes() {
            const container = document.getElementById('notesDetected');
            container.innerHTML = '';
            state.detectedNotes.forEach(note => {
                const badge = document.createElement('span');
                badge.className = 'note-badge';
                badge.textContent = note;
                container.appendChild(badge);
            });
        }

        function finishVocalTest() {
            state.isTestRunning = false;
            document.getElementById('startTestBtn').style.display = 'block';
            document.getElementById('stopTestBtn').style.display = 'none';

            const highest = state.highestNote || '--';
            const lowest = state.lowestNote || '--';

            let range = '--';
            if (state.highestNote && state.lowestNote) {
                const highestIdx = NOTE_NAMES.indexOf(state.highestNote);
                const lowestIdx = NOTE_NAMES.indexOf(state.lowestNote);
                const semitones = highestIdx - lowestIdx;
                const octaves = Math.floor(semitones / 12);
                range = `${octaves} oitava${octaves !== 1 ? 's' : ''}`;
            }

            document.getElementById('resultHighest').textContent = highest;
            document.getElementById('resultLowest').textContent = lowest;
            document.getElementById('resultRange').textContent = range;

            // An√°lise de vozes
            if (state.lowestFreq !== Infinity && state.highestFreq > 0) {
                const { vocesAlcancadas, vozMaisProxima } = analyzeVoiceRanges(state.lowestFreq, state.highestFreq);
                displayVoiceAnalysis(vocesAlcancadas, vozMaisProxima);
            }

            document.getElementById('resultSection').style.display = 'block';
            document.getElementById('progressContainer').style.display = 'none';
        }

        function stopVocalTest() {
            state.isTestRunning = false;
            document.getElementById('startTestBtn').style.display = 'block';
            document.getElementById('stopTestBtn').style.display = 'none';
        }

        function resetVocalTest() {
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('pitchCanvas').style.display = 'none';
            document.getElementById('chartInfo').style.display = 'none';
            document.getElementById('progressContainer').style.display = 'none';
            document.getElementById('notesDetected').innerHTML = '';
            document.getElementById('testStatus').textContent = 'Clique abaixo para come√ßar';
        }
    </script>
</body>
</html>
